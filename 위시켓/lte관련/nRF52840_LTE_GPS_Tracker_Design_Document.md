# nRF52840 기반 LTE/GPS 트래커 시스템 설계서

## 프로젝트 개요

| 항목 | 내용 |
|------|------|
| **프로젝트명** | nRF52840 기반 다기능 LTE/GPS 트래커 개발 |
| **설계일** | 2024년 9월 11일 |
| **메인 MCU** | Nordic nRF52840-QFAA |
| **LTE 모듈** | Quectel EG915UE (LTE Cat1) |
| **GPS 모듈** | Quectel LG77L |
| **주요 기능** | LTE 통신, GPS 위치추적, BLE, 9축 IMU, 환경 센서 |

---

## 1. 시스템 구성도

```
┌────────────────────────────────────────────────────────────────────────────┐
│                        LTE/GPS TRACKER SYSTEM                              │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    POWER MANAGEMENT BLOCK                           │   │
│  │                                                                     │   │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐      │   │
│  │  │  24V IN  │───►│ MP4560DN │───►│  5V Rail │───►│ MIC2514  │      │   │
│  │  │  (J203)  │    │ Buck DC  │    │ VCC_5V   │    │ LDO      │      │   │
│  │  └──────────┘    └──────────┘    └──────────┘    └────┬─────┘      │   │
│  │                                                       │             │   │
│  │  ┌──────────┐    ┌──────────┐                   ┌─────▼─────┐      │   │
│  │  │ Battery  │───►│ BQ24072  │───────────────────►│  VCC_GPS  │      │   │
│  │  │  (J202)  │    │ Charger  │    V_SYS          │  3.3V     │      │   │
│  │  └──────────┘    └──────────┘                   └───────────┘      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                            │
│  ┌─────────────────────┐    ┌─────────────────────┐                       │
│  │   nRF52840-QFAA     │    │    EG915UE LTE      │                       │
│  │   (Main MCU)        │    │    Module           │                       │
│  │                     │    │                     │                       │
│  │  - BLE 5.0          │    │  - LTE Cat1         │                       │
│  │  - 32MHz XTAL       │◄──►│  - 10/5 Mbps        │◄──► LTE Antenna       │
│  │  - 32.768kHz RTC    │UART│  - GSM/GPRS         │     (MHF J1)          │
│  │  - ARM Cortex-M4F   │    │  - Nano SIM         │                       │
│  │                     │    │                     │                       │
│  └──────────┬──────────┘    └─────────────────────┘                       │
│             │                                                              │
│             │ I2C                                                          │
│  ┌──────────▼──────────────────────────────────────────────────────────┐   │
│  │                      SENSOR BLOCK                                   │   │
│  │                                                                     │   │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐      │   │
│  │  │  LG77L   │    │ MPU9250  │    │ ICM20948 │    │  AHT20   │      │   │
│  │  │  GNSS    │    │  9-Axis  │    │  9-Axis  │    │ Temp/Hum │      │   │
│  │  │  Module  │    │   IMU    │    │   IMU    │    │  Sensor  │      │   │
│  │  └──────────┘    └──────────┘    └──────────┘    └──────────┘      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      INTERFACE BLOCK                                │   │
│  │                                                                     │   │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐      │   │
│  │  │  SWD     │    │  UART    │    │   LED    │    │  Alarm   │      │   │
│  │  │  Debug   │    │  Mux     │    │ Indicator│    │  Input   │      │   │
│  │  │  (J103)  │    │ MAX4052  │    │  x6      │    │  (J205)  │      │   │
│  │  └──────────┘    └──────────┘    └──────────┘    └──────────┘      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 핵심 부품 목록 (BOM)

### 2.1 주요 IC

| 참조번호 | 부품명 | 제조사 | 설명 |
|----------|--------|--------|------|
| **U304** | nRF52840-QFAA | Nordic | 메인 MCU, BLE 5.0, ARM Cortex-M4F |
| **U1** | EG915UE | Quectel | LTE Cat1 모듈 |
| **U3** | LG77L | Quectel | GNSS 모듈 (GPS/GLONASS/Galileo/BeiDou) |
| **U301** | MPU9250 | TDK InvenSense | 9축 IMU (가속도계/자이로/지자기) |
| **U305** | ICM20948 | TDK InvenSense | 9축 IMU (백업/대체) |
| **U300** | AHT20 | ASAIR | 온습도 센서 |
| **U6** | TXS0108E | Texas Instruments | 8채널 양방향 레벨 시프터 |
| **U7** | MAX4052 | Maxim | 듀얼 4:1 아날로그 멀티플렉서 |
| **U200** | MP4560DN | MPS | 동기식 강압 DC-DC 컨버터 |
| **U302** | BQ24072 | Texas Instruments | 리튬이온 배터리 충전 IC |
| **U203** | MIC2514 | Microchip | 전류 제한 파워 스위치 |
| **U303** | XYY-0029-06140 | - | Nano SIM 카드 소켓 |

### 2.2 수동 소자 및 기타

| 구분 | 부품 | 수량 | 설명 |
|------|------|------|------|
| **커넥터** | MHF J1, J2 | 2 | RF 안테나 커넥터 |
| **안테나** | ALA931C5 (ANT2) | 1 | BLE/2.4GHz 칩 안테나 |
| **크리스탈** | 32MHz (X4) | 1 | 메인 클럭 |
| **크리스탈** | 32.768kHz (X3) | 1 | RTC 클럭 |
| **LED** | LED1608 | 6 | 상태 표시 LED |
| **트랜지스터** | MMBT2222A | 8 | NPN 스위칭 트랜지스터 |
| **ESD 보호** | CESDLC5V0M5 | 1 | SIM 카드 ESD 보호 |
| **TVS 다이오드** | EZA-EG1N50AC | 2 | 안테나 ESD 보호 |
| **서지 보호** | SMBJ48A | 1 | 24V 입력 서지 보호 |

---

## 3. 상세 회로 설계

### 3.1 메인 MCU - nRF52840-QFAA

#### 3.1.1 사양

| 항목 | 사양 |
|------|------|
| **코어** | ARM Cortex-M4F @ 64MHz |
| **Flash** | 1MB |
| **RAM** | 256KB |
| **무선** | Bluetooth 5.0, 802.15.4, ANT |
| **GPIO** | 48개 |
| **ADC** | 12-bit, 8채널 |
| **인터페이스** | UART, SPI, I2C, QSPI, PWM |

#### 3.1.2 핀 할당

| GPIO | 기능 | 연결 대상 |
|------|------|-----------|
| P0.00 | XL1 | 32.768kHz 크리스탈 |
| P0.01 | XL2 | 32.768kHz 크리스탈 |
| P0.04 | AIN2/TX | UART TX (배터리 ADC) |
| P0.05 | AIN3/RX | UART RX |
| P0.07 | - | nrf_GPS_1PPS |
| P0.08 | - | nrf_PWRKEY (LTE 전원 제어) |
| P0.09 | NFC1 | nrf_SDA (I2C 데이터) |
| P0.10 | NFC2 | nrf_SCL (I2C 클럭) |
| P0.11 | - | nrf_TXD (UART MUX) |
| P0.12 | - | nrf_RXD (UART MUX) |
| P0.13 | - | PWR_CTR (전원 제어) |
| P0.14 | - | nrf_UART_ADD1 (UART 선택) |
| P0.17 | - | nrf_UART_ADD0 (UART 선택) |
| P0.18 | RESET | 리셋 핀 |
| P0.19 | - | nrf_RESET_N (LTE 리셋) |
| P0.20 | - | nrf_MAIN_DTR |
| P0.21 | - | nrf_MAIN_RI |
| P0.22 | - | GNSS 제어 |
| P0.23 | - | LTE 제어 |
| P0.24 | - | PWR_1 (LED) |
| P1.00 | - | PWR_2 (LED) |
| P1.08 | - | nrf_GPS_WAKEUP |
| P1.09 | - | nrf_GPS_RESET_N |
| P1.15 | - | nrf_PWR_CTR |
| P0.26 | SWDIO | SWD 디버그 |
| P0.27 | SWDCLK | SWD 클럭 |
| P0.30 | AIN6 | alarm 입력 |
| P0.31 | ANT | BLE 안테나 |

#### 3.1.3 클럭 구성

```
┌─────────────────────────────────────────────────────────┐
│                   Clock System                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────┐         ┌──────────────────────┐     │
│  │ 32MHz XTAL   │────────►│  HFCLK (High Freq)   │     │
│  │ X4 (8pF)     │         │  - CPU Clock         │     │
│  │ C121, C122   │         │  - Radio Clock       │     │
│  └──────────────┘         └──────────────────────┘     │
│                                                         │
│  ┌──────────────┐         ┌──────────────────────┐     │
│  │ 32.768kHz    │────────►│  LFCLK (Low Freq)    │     │
│  │ X3 (9pF)     │         │  - RTC Clock         │     │
│  │ C118         │         │  - Low Power Timer   │     │
│  └──────────────┘         └──────────────────────┘     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.2 LTE 모듈 - Quectel EG915UE

#### 3.2.1 사양

| 항목 | 사양 |
|------|------|
| **카테고리** | LTE Cat1 |
| **다운로드** | 최대 10 Mbps |
| **업로드** | 최대 5 Mbps |
| **네트워크** | LTE-FDD, GSM/GPRS/EDGE |
| **주파수** | B1/B3/B5/B7/B8/B20/B28 (EU) |
| **SIM** | Nano SIM (1.8V/3.0V) |

#### 3.2.2 인터페이스 연결

| EG915UE 핀 | 신호명 | 연결 | 설명 |
|------------|--------|------|------|
| Pin 8 | USB_VBUS | VBUS_nRF | USB 전원 |
| Pin 9 | USB_DP | D+ | USB 데이터+ |
| Pin 10 | USB_DM | D- | USB 데이터- |
| Pin 15 | PWRKEY | nrf_PWRKEY | 전원 키 제어 |
| Pin 17 | RESET_N | nrf_RESET_N | 리셋 제어 |
| Pin 20 | STATUS | LED_STATUS | 상태 LED |
| Pin 21 | NET_STATUS | LED_NET_STATUS | 네트워크 상태 LED |
| Pin 22 | DBG_RXD | DBG_RXD | 디버그 UART RX |
| Pin 23 | DBG_TXD | DBG_TXD | 디버그 UART TX |
| Pin 29 | VDD_EXT | VDD_EXT (1.8V) | I/O 전압 출력 |
| Pin 30 | MAIN_DTR | nrf_MAIN_DTR | 데이터 터미널 준비 |
| Pin 33 | MAIN_RXD | MAIN_RXD | 메인 UART RX |
| Pin 34 | MAIN_TXD | MAIN_TXD | 메인 UART TX |
| Pin 38 | MAIN_RI | nrf_MAIN_RI | 링 인디케이터 |
| Pin 42-47 | USIM1_* | SIM 소켓 | SIM 카드 인터페이스 |
| Pin 60 | ANT_MAIN | MHF J1 | LTE 메인 안테나 |

#### 3.2.3 레벨 시프터 (TXS0108E)

nRF52840 (3.3V) ↔ EG915UE (1.8V VDD_EXT) 간 레벨 변환:

| A측 (1.8V) | B측 (3.3V) | 신호 |
|------------|------------|------|
| A1 | B1 | MAIN_TXD / nrf_MAIN_TXD |
| A2 | B2 | GPS_TXD / nrf_GPS_TXD |
| A3 | B3 | MAIN_RXD / nrf_MAIN_RXD |
| A4 | B4 | GPS_RXD / nrf_GPS_RXD |
| A5 | B5 | GPS_WAKEUP / nrf_GPS_WAKEUP |
| A6 | B6 | GPS_RESET_N / nrf_GPS_RESET_N |
| A7 | B7 | MAIN_DTR / nrf_MAIN_DTR |
| A8 | B8 | MAIN_RI / nrf_MAIN_RI |

### 3.3 GNSS 모듈 - Quectel LG77L

#### 3.3.1 사양

| 항목 | 사양 |
|------|------|
| **지원 위성** | GPS, GLONASS, Galileo, BeiDou |
| **채널** | 33 Tracking, 99 Acquisition |
| **감도** | -148dBm (Tracking) |
| **정확도** | 2.5m CEP |
| **TTFF** | Cold: 26s, Hot: 1s |
| **인터페이스** | UART, I2C |

#### 3.3.2 핀 연결

| LG77L 핀 | 신호명 | 연결 | 설명 |
|----------|--------|------|------|
| Pin 1 | RF_IN | MHF J2 | GPS 안테나 |
| Pin 13 | WAKEUP | GPS_WAKEUP | 웨이크업 |
| Pin 14 | RESET_N | GPS_RESET_N | 리셋 |
| Pin 15 | RXD | GPS_RXD | UART RX |
| Pin 16 | TXD | GPS_TXD | UART TX |
| Pin 19 | VCC | VCC_GPS | 전원 (3.3V) |
| Pin 20 | VCC_IO | VDD_EXT | I/O 전압 |
| Pin 21 | V_BCKP | VCC_GPS | 백업 전원 |
| Pin 29 | I2C_SCL | nrf_SCL | I2C 클럭 |
| Pin 30 | I2C_SDA | nrf_SDA | I2C 데이터 |
| Pin 31 | 1PPS | nrf_GPS_1PPS | 1초 펄스 출력 |

### 3.4 UART 멀티플렉서 - MAX4052

nRF52840의 단일 UART를 LTE와 GPS 모듈에 선택적으로 연결:

```
┌────────────────────────────────────────────────────────────────┐
│                    UART Multiplexer (MAX4052)                  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  nrf_UART_ADD1  nrf_UART_ADD0    선택 채널                     │
│       0              0           NO0 (MAIN UART - LTE)         │
│       0              1           NO1 (GPS UART)                │
│       1              0           NO2 (Reserved)                │
│       1              1           NO3 (Reserved)                │
│                                                                │
│  ┌──────────┐                         ┌──────────────┐        │
│  │ nRF52840 │                         │   EG915UE    │        │
│  │          │    ┌─────────┐          │   (LTE)      │        │
│  │ nrf_TXD  │───►│ COMA    │──NO0A───►│ MAIN_RXD    │        │
│  │ nrf_RXD  │◄───│ COMB    │◄─NO0B────│ MAIN_TXD    │        │
│  │          │    │         │          └──────────────┘        │
│  │ ADD0     │───►│ ADDA    │                                  │
│  │ ADD1     │───►│ ADDB    │          ┌──────────────┐        │
│  │          │    │         │──NO1A───►│   LG77L      │        │
│  └──────────┘    │         │◄─NO1B────│   (GPS)      │        │
│                  └─────────┘          └──────────────┘        │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## 4. 센서 시스템

### 4.1 9축 IMU - MPU9250 / ICM20948

#### 4.1.1 MPU9250 사양

| 항목 | 사양 |
|------|------|
| **가속도계** | ±2g, ±4g, ±8g, ±16g |
| **자이로스코프** | ±250, ±500, ±1000, ±2000 °/s |
| **지자기센서** | ±4800 μT |
| **인터페이스** | I2C (400kHz), SPI (1MHz) |
| **동작 전압** | 2.4V ~ 3.6V |

#### 4.1.2 ICM20948 사양 (백업/대체)

| 항목 | 사양 |
|------|------|
| **가속도계** | ±2g, ±4g, ±8g, ±16g |
| **자이로스코프** | ±250, ±500, ±1000, ±2000 °/s |
| **지자기센서** | ±4900 μT |
| **DMP** | 내장 (센서 퓨전) |
| **인터페이스** | I2C, SPI |

#### 4.1.3 I2C 연결

```
VCC_GPS (3.3V)
    │
    ├───┬───────────────────────────────────┬───────────────────┐
    │   │                                   │                   │
   ┌┴┐ ┌┴┐                                 ┌┴┐                 ┌┴┐
   │R│ │R│ 10K Pull-up                     │R│                 │R│
   │3│ │3│                                 │3│                 │3│
   │0│ │0│                                 │0│                 │0│
   │0│ │1│                                 │3│                 │4│
   └┬┘ └┬┘                                 └┬┘                 └┬┘
    │   │                                   │                   │
    │   └──────────────┬────────────────────┼───────────────────┤
    │                  │                    │                   │
    │   nrf_SCL ───────┼────────────────────┼───────────────────┤
    │                  │                    │                   │
    └──────────────────┼────────────────────┤                   │
                       │                    │                   │
        nrf_SDA ───────┴────────────────────┴───────────────────┘
                       │                    │                   │
                  ┌────┴────┐          ┌────┴────┐         ┌────┴────┐
                  │  AHT20  │          │ MPU9250 │         │ICM20948 │
                  │  (U300) │          │  (U301) │         │ (U305)  │
                  └─────────┘          └─────────┘         └─────────┘
```

### 4.2 온습도 센서 - AHT20

| 항목 | 사양 |
|------|------|
| **온도 범위** | -40°C ~ +85°C |
| **온도 정확도** | ±0.3°C |
| **습도 범위** | 0% ~ 100% RH |
| **습도 정확도** | ±2% RH |
| **인터페이스** | I2C |
| **I2C 주소** | 0x38 |

---

## 5. 센서 기반 확장 기능

MPU9250, ICM20948 (9축 IMU)와 AHT20 (온습도 센서)를 활용하여 다양한 고급 기능을 구현할 수 있습니다.

### 5.1 IMU 기반 기능 (MPU9250 / ICM20948)

#### 5.1.1 동작 감지 및 분류

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    MOTION DETECTION SYSTEM                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────────────┐     │
│  │ Accelerometer│─────►│  Motion     │─────►│ Event Classification│     │
│  │ (±16g)      │      │  Detection  │      │                     │     │
│  └─────────────┘      └─────────────┘      │ - 정지 (Stationary) │     │
│                                             │ - 걷기 (Walking)    │     │
│  ┌─────────────┐      ┌─────────────┐      │ - 달리기 (Running)  │     │
│  │ Gyroscope   │─────►│  Rotation   │─────►│ - 차량 이동 (Driving)│     │
│  │ (±2000°/s)  │      │  Analysis   │      │ - 낙하 (Fall)       │     │
│  └─────────────┘      └─────────────┘      │ - 충격 (Impact)     │     │
│                                             └─────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────┘
```

| 기능 | 설명 | 활용 센서 |
|------|------|-----------|
| **이동 감지** | 장치 움직임 시작/종료 감지 | 가속도계 |
| **충격 감지** | 급격한 가속도 변화 감지 (사고/낙하) | 가속도계 |
| **기울기 감지** | 장치 기울어짐 감지 | 가속도계 |
| **회전 감지** | 장치 회전 감지 | 자이로스코프 |
| **자유낙하 감지** | 중력 가속도 소실 감지 | 가속도계 |
| **진동 분석** | 진동 패턴 및 주파수 분석 | 가속도계 |

#### 5.1.2 자세 추정 (Attitude Estimation)

```c
// 센서 퓨전 알고리즘 (Madgwick/Mahony Filter)
typedef struct {
    float roll;      // X축 회전 (좌우 기울기)
    float pitch;     // Y축 회전 (앞뒤 기울기)
    float yaw;       // Z축 회전 (방위각)
    float quaternion[4];  // 쿼터니언 표현
} attitude_t;

// 센서 퓨전 예시
void update_attitude(float ax, float ay, float az,
                     float gx, float gy, float gz,
                     float mx, float my, float mz) {
    // Madgwick 필터 또는 칼만 필터 적용
    // 가속도계 + 자이로 + 지자기 데이터 융합
    MadgwickAHRSupdate(gx, gy, gz, ax, ay, az, mx, my, mz);
}
```

| 기능 | 설명 | 알고리즘 |
|------|------|----------|
| **Roll/Pitch/Yaw** | 3축 오일러 각도 계산 | Complementary Filter |
| **쿼터니언 자세** | 짐벌락 없는 자세 표현 | Madgwick/Mahony Filter |
| **방위각 (Heading)** | 지자기 기반 절대 방향 | Tilt-Compensated Compass |
| **Dead Reckoning** | GPS 불가 시 위치 추정 | IMU + GPS Fusion |

#### 5.1.3 보행자 항법 (PDR: Pedestrian Dead Reckoning)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                PEDESTRIAN DEAD RECKONING (PDR)                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐              │
│  │   걸음 감지   │───►│  걸음 길이   │───►│   위치 추정   │              │
│  │ Step Detection│    │ Step Length  │    │  Position    │              │
│  └──────────────┘    └──────────────┘    └──────────────┘              │
│         │                   │                   │                       │
│         ▼                   ▼                   ▼                       │
│  가속도계 피크 감지   보폭 추정 모델      GPS 위치 + 이동 벡터           │
│  (Peak Detection)    (Weinberg Model)    (Position Update)             │
│                                                                         │
│  수식: Step Length = K × (Amax - Amin)^0.25                            │
│        Position(n+1) = Position(n) + StepLength × [cos(θ), sin(θ)]    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

| 기능 | 설명 | 정확도 |
|------|------|--------|
| **걸음 수 계산** | 가속도 피크 감지 기반 | 95% 이상 |
| **이동 거리 추정** | 보폭 × 걸음 수 | ±5% |
| **이동 방향 추정** | 지자기 기반 heading | ±5° |
| **실내 위치 추적** | GPS 불가 영역 위치 추정 | 1~3m |

#### 5.1.4 차량 동작 분석

| 기능 | 설명 | 임계값 예시 |
|------|------|-------------|
| **급가속 감지** | 전방 가속도 급증 | > 0.3g |
| **급감속 감지** | 전방 가속도 급감 | < -0.4g |
| **급회전 감지** | 횡방향 가속도 | > 0.25g |
| **과속방지턱 감지** | 수직 충격 | > 0.5g spike |
| **사고 감지** | 다축 급격한 변화 | > 4g 복합 |
| **전복 감지** | Roll 각도 임계 초과 | > 60° |

```c
// 차량 이벤트 감지 예시
typedef enum {
    EVENT_NONE = 0,
    EVENT_HARSH_ACCEL,      // 급가속
    EVENT_HARSH_BRAKE,      // 급제동
    EVENT_HARSH_TURN,       // 급회전
    EVENT_SPEED_BUMP,       // 과속방지턱
    EVENT_COLLISION,        // 충돌
    EVENT_ROLLOVER          // 전복
} vehicle_event_t;

vehicle_event_t detect_vehicle_event(imu_data_t *data) {
    float accel_magnitude = sqrt(data->ax*data->ax +
                                  data->ay*data->ay +
                                  data->az*data->az);

    if (accel_magnitude > 4.0f) return EVENT_COLLISION;
    if (data->ax > 0.3f) return EVENT_HARSH_ACCEL;
    if (data->ax < -0.4f) return EVENT_HARSH_BRAKE;
    if (fabs(data->ay) > 0.25f) return EVENT_HARSH_TURN;
    if (fabs(data->roll) > 60.0f) return EVENT_ROLLOVER;

    return EVENT_NONE;
}
```

#### 5.1.5 진동 모니터링 (산업용)

| 기능 | 설명 | 활용 분야 |
|------|------|-----------|
| **FFT 진동 분석** | 주파수 스펙트럼 분석 | 기계 상태 모니터링 |
| **RMS 진동 레벨** | 진동 강도 측정 | 설비 이상 감지 |
| **베어링 손상 감지** | 특정 주파수 패턴 감지 | 예지 정비 |
| **공진 감지** | 공진 주파수 식별 | 구조물 안전 |

### 5.2 온습도 센서 기반 기능 (AHT20)

#### 5.2.1 환경 모니터링

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   ENVIRONMENTAL MONITORING                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐      ┌─────────────────┐      ┌───────────────────┐   │
│  │   AHT20     │─────►│   Data Logger   │─────►│   Alert System    │   │
│  │  Temp/Hum   │      │   & Analysis    │      │                   │   │
│  └─────────────┘      └─────────────────┘      │ - 고온 경고       │   │
│                                                 │ - 저온 경고       │   │
│  측정 범위:                                     │ - 고습 경고       │   │
│  - 온도: -40°C ~ +85°C                         │ - 결로점 경고     │   │
│  - 습도: 0% ~ 100% RH                          │ - 열지수 경고     │   │
│                                                 └───────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

| 기능 | 설명 | 계산 공식 |
|------|------|-----------|
| **이슬점 계산** | 결로 발생 온도 예측 | Td = T - ((100-RH)/5) |
| **열지수 계산** | 체감 온도 산출 | Heat Index 공식 |
| **불쾌지수** | 쾌적도 판단 | DI = 0.81T + 0.01RH(0.99T-14.3) + 46.3 |
| **절대습도** | 공기 중 수증기량 | AH = (RH/100) × 6.112 × exp(...) |

```c
// 환경 지수 계산 예시
typedef struct {
    float temperature;      // °C
    float humidity;         // %RH
    float dew_point;        // 이슬점 °C
    float heat_index;       // 열지수 °C
    float discomfort_index; // 불쾌지수
} environment_data_t;

float calculate_dew_point(float temp, float humidity) {
    float a = 17.27f;
    float b = 237.7f;
    float alpha = ((a * temp) / (b + temp)) + log(humidity / 100.0f);
    return (b * alpha) / (a - alpha);
}

float calculate_heat_index(float temp, float humidity) {
    // Rothfusz regression equation
    float hi = -42.379 + 2.04901523*temp + 10.14333127*humidity
               - 0.22475541*temp*humidity - 0.00683783*temp*temp
               - 0.05481717*humidity*humidity + 0.00122874*temp*temp*humidity
               + 0.00085282*temp*humidity*humidity
               - 0.00000199*temp*temp*humidity*humidity;
    return hi;
}
```

#### 5.2.2 콜드체인 모니터링

| 기능 | 설명 | 임계값 예시 |
|------|------|-------------|
| **온도 이탈 감지** | 설정 범위 초과 시 알람 | 2°C ~ 8°C (백신) |
| **온도 이력 기록** | 시간별 온도 로그 | 5분 간격 |
| **누적 이탈 시간** | 이탈 총 시간 계산 | 30분 초과 경고 |
| **평균 운동 온도 (MKT)** | 열 스트레스 지표 | Arrhenius 방정식 |

#### 5.2.3 보관 환경 관리

| 응용 분야 | 온도 범위 | 습도 범위 |
|-----------|-----------|-----------|
| **의약품 보관** | 2°C ~ 8°C | 35% ~ 65% |
| **식품 냉장** | 0°C ~ 4°C | - |
| **전자제품** | 15°C ~ 35°C | 30% ~ 70% |
| **미술품/문서** | 18°C ~ 22°C | 45% ~ 55% |
| **데이터센터** | 18°C ~ 27°C | 40% ~ 60% |

### 5.3 복합 센서 융합 기능

#### 5.3.1 GPS + IMU 융합 (Sensor Fusion)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    GPS + IMU SENSOR FUSION                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐                        ┌───────────────────────────┐  │
│  │   LG77L     │───── 1Hz Position ────►│                           │  │
│  │   GPS       │                        │    Extended Kalman        │  │
│  └─────────────┘                        │    Filter (EKF)           │  │
│                                          │                           │  │
│  ┌─────────────┐                        │    출력:                  │  │
│  │  MPU9250    │─── 100Hz IMU Data ───►│    - 위치 (10Hz 이상)     │  │
│  │   IMU       │                        │    - 속도                 │  │
│  └─────────────┘                        │    - 방향                 │  │
│                                          │    - GPS 보간 위치       │  │
│                                          └───────────────────────────┘  │
│                                                                         │
│  장점:                                                                  │
│  - GPS 업데이트 사이 위치 추정 (100Hz)                                 │
│  - GPS 음영 지역 위치 유지                                             │
│  - GPS 노이즈 필터링                                                   │
│  - 터널/건물 내부 위치 추정                                            │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 5.3.2 스마트 알람 시스템

| 이벤트 | 센서 조합 | 트리거 조건 |
|--------|-----------|-------------|
| **차량 사고** | IMU + GPS | 충격(>4g) + 급속도 변화 |
| **낙상 감지** | IMU | 자유낙하 + 충격 + 정지 |
| **도난 감지** | IMU + GPS | 이동 감지 + 지오펜스 이탈 |
| **열사병 위험** | AHT20 + IMU | 고온 + 활동량 증가 |
| **동상 위험** | AHT20 + GPS | 저온 + 장시간 정지 |
| **화물 손상** | IMU + AHT20 | 충격/온도 이탈 |

#### 5.3.3 활동 추적 (Activity Tracking)

```c
typedef struct {
    uint32_t steps;              // 걸음 수
    float distance_km;           // 이동 거리
    float calories;              // 소모 칼로리
    uint32_t active_minutes;     // 활동 시간
    activity_type_t activity;    // 현재 활동 유형
    float avg_temperature;       // 평균 환경 온도
    float avg_humidity;          // 평균 환경 습도
} activity_data_t;

typedef enum {
    ACTIVITY_STATIONARY,    // 정지
    ACTIVITY_WALKING,       // 걷기
    ACTIVITY_RUNNING,       // 달리기
    ACTIVITY_CYCLING,       // 자전거
    ACTIVITY_DRIVING,       // 운전
    ACTIVITY_SLEEPING       // 수면
} activity_type_t;

// 활동 분류 알고리즘
activity_type_t classify_activity(imu_data_t *imu, gps_data_t *gps) {
    float accel_variance = calculate_variance(imu->accel_history, 50);
    float speed = gps->speed_kmh;

    if (accel_variance < 0.01f) {
        return ACTIVITY_STATIONARY;
    } else if (speed > 15.0f && accel_variance < 0.1f) {
        return ACTIVITY_DRIVING;
    } else if (speed > 12.0f) {
        return ACTIVITY_CYCLING;
    } else if (accel_variance > 2.0f) {
        return ACTIVITY_RUNNING;
    } else {
        return ACTIVITY_WALKING;
    }
}
```

### 5.4 저전력 이벤트 감지 (Motion-Triggered Wake-up)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                  LOW POWER MOTION DETECTION                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────┐                                                   │
│  │    SLEEP MODE   │◄──────────────────────────────────┐              │
│  │   (~5μA)        │                                   │              │
│  └────────┬────────┘                                   │              │
│           │ Motion Interrupt                           │              │
│           ▼                                            │              │
│  ┌─────────────────┐                                   │              │
│  │  MPU9250 WOM    │  Wake-on-Motion 인터럽트          │              │
│  │  (Wake-on-      │  - 임계값 초과 시 INT 발생        │              │
│  │   Motion)       │  - MCU 전력 소모 최소화           │              │
│  └────────┬────────┘                                   │              │
│           │                                            │              │
│           ▼                                            │              │
│  ┌─────────────────┐      ┌─────────────────┐         │              │
│  │  ACTIVE MODE    │─────►│  Data Process   │─────────┘              │
│  │  (Full Power)   │      │  & Transmit     │  No Motion Timeout     │
│  └─────────────────┘      └─────────────────┘                        │
│                                                                         │
│  전력 소모 비교:                                                       │
│  - 연속 GPS + LTE: ~200mA                                             │
│  - Motion-Triggered: 평균 ~5mA (90% 슬립 가정)                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

| 모드 | 트리거 | 동작 | 전류 소모 |
|------|--------|------|-----------|
| **Deep Sleep** | 없음 | MCU + 센서 슬립 | ~5μA |
| **Motion Wake** | IMU 인터럽트 | MCU 웨이크업 | ~1mA |
| **GPS Acquisition** | 타이머/이벤트 | GPS 위치 획득 | ~30mA |
| **LTE Transmission** | 데이터 전송 | 서버로 전송 | ~200mA |

### 5.5 기능 요약 테이블

| 센서 | 기능 | 산업 응용 |
|------|------|-----------|
| **MPU9250/ICM20948** | 동작 감지, 자세 추정, 충격 감지 | 차량 추적, 물류, 안전 |
| | 걸음 수 계산, PDR | 피트니스, 실내 위치 |
| | 진동 분석, FFT | 산업 설비 모니터링 |
| | 사고/낙상 감지 | 고령자 케어, 보험 |
| **AHT20** | 온습도 모니터링 | 콜드체인, 창고 |
| | 열지수/불쾌지수 | 작업장 안전 |
| | 결로점 계산 | 전자제품 보관 |
| **GPS + IMU** | 센서 퓨전 | 고정밀 추적 |
| | 터널/실내 위치 | 물류 추적 |
| **IMU + AHT20** | 활동 + 환경 | 스포츠, 헬스케어 |
| | 화물 상태 모니터링 | 운송 품질 관리 |

---

## 6. 전원 시스템

### 6.1 전원 구조

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         POWER DISTRIBUTION                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌──────────┐                                                          │
│   │  24V DC  │                                                          │
│   │  (J203)  │                                                          │
│   └────┬─────┘                                                          │
│        │                                                                │
│        ▼                                                                │
│   ┌──────────┐      ┌──────────┐                                       │
│   │ SMBJ48A  │      │ MP4560DN │      VCC_5V                           │
│   │  TVS     │─────►│ Buck     │─────────────────────────────┐         │
│   │ (D200)   │      │ 24V→5V   │                             │         │
│   └──────────┘      └──────────┘                             │         │
│                                                               │         │
│   ┌──────────┐      ┌──────────┐      ┌──────────┐          │         │
│   │ Battery  │      │ BQ24072  │      │          │          │         │
│   │ Li-Ion   │◄────►│ Charger  │◄─────│ VCC_5V   │          │         │
│   │ (J202)   │      │          │      │          │          │         │
│   └────┬─────┘      └────┬─────┘      └──────────┘          │         │
│        │                 │                                   │         │
│        │                 │ V_SYS                             │         │
│        │                 ▼                                   │         │
│        │           ┌──────────┐                              │         │
│        └──────────►│ MIC2514  │      VCC_GPS (3.3V)          │         │
│       VCC_BAT      │ LDO      │──────────────────────────────┤         │
│                    │ (U203)   │                              │         │
│                    └──────────┘                              │         │
│                         │                                    │         │
│                         │ nrf_PWR_CTR (ON/OFF 제어)          │         │
│                         ▼                                    │         │
│                    ┌──────────────────────────────────────┐  │         │
│                    │           VCC_GPS (3.3V)             │  │         │
│                    │                                      │  │         │
│                    │  ┌─────────┐  ┌─────────┐           │  │         │
│                    │  │nRF52840 │  │ EG915UE │           │  │         │
│                    │  │         │  │  (LTE)  │           │  │         │
│                    │  └─────────┘  └─────────┘           │  │         │
│                    │                                      │  │         │
│                    │  ┌─────────┐  ┌─────────┐           │  │         │
│                    │  │  LG77L  │  │ Sensors │           │  │         │
│                    │  │  (GPS)  │  │         │           │  │         │
│                    │  └─────────┘  └─────────┘           │  │         │
│                    └──────────────────────────────────────┘  │         │
│                                                               │         │
└───────────────────────────────────────────────────────────────┴─────────┘
```

### 6.2 DC-DC 컨버터 - MP4560DN

| 항목 | 사양 |
|------|------|
| **입력 전압** | 4.5V ~ 55V |
| **출력 전압** | 5V (설정값) |
| **출력 전류** | 최대 2A |
| **효율** | 최대 92% |
| **스위칭 주파수** | 385kHz (Typ) |
| **보호 기능** | 과전류, 과열, 저전압 |

#### 피드백 저항 계산

```
VOUT = 0.8V × (1 + R202/R201)
     = 0.8V × (1 + 47.5K/40.2K)
     = 0.8V × 2.18
     ≈ 1.74V ... (회로 재검토 필요, 실제 5V 출력을 위한 저항값 조정 예상)
```

### 6.3 배터리 충전 IC - BQ24072

| 항목 | 사양 |
|------|------|
| **입력 전압** | 4.35V ~ 6.4V |
| **충전 전압** | 4.2V (Li-Ion) |
| **충전 전류** | ISET 핀으로 설정 |
| **종료 전류** | 설정 가능 |
| **상태 출력** | /CHG, /PG |

#### 충전 전류 설정

```
ICHARGE = KISET / RISET
        = 890 / R308
        = 890 / 46.4K × 1000
        ≈ 19.2mA (실제 설계값 확인 필요)
```

### 6.4 전원 스위치 - MIC2514

| 항목 | 사양 |
|------|------|
| **입력 전압** | 2.7V ~ 5.5V |
| **출력 전류** | 최대 500mA |
| **제어** | CTL 핀 (Active High) |
| **보호** | 과전류, 단락, 역전류 |

---

## 6. LED 인디케이터

### 6.1 LED 배치

| LED | 색상 | GPIO | 기능 |
|-----|------|------|------|
| D104 | RED | - | LTE 상태 |
| D105 | RED | PWR | 전원 상태 |
| D106 | RED | LTE | LTE 연결 |
| D107 | BLUE | GNSS | GPS 상태 |
| D108 | GREEN | PWR_1 | 전원 1 |
| D109 | BLUE | PWR_2 | 전원 2 |
| D3 | LED | STATUS | EG915 상태 |
| D4 | LED | NET_STATUS | 네트워크 상태 |

### 6.2 LED 드라이버 회로

```
VDD_3V ─────┬─────┬─────┬─────┐
            │     │     │     │
           ┌┴┐   ┌┴┐   ┌┴┐   ┌┴┐
           │R│   │R│   │R│   │R│  470Ω
           │1│   │1│   │1│   │1│
           │1│   │1│   │1│   │2│
           │4│   │5│   │6│   │0│
           └┬┘   └┬┘   └┬┘   └┬┘
            │     │     │     │
           ┌┴┐   ┌┴┐   ┌┴┐   ┌┴┐
           │▼│   │▼│   │▼│   │▼│  LED
           │D│   │D│   │D│   │D│
           │1│   │1│   │1│   │1│
           │0│   │0│   │0│   │0│
           │4│   │5│   │6│   │9│
           └┬┘   └┬┘   └┬┘   └┬┘
            │     │     │     │
            ▼     ▼     ▼     ▼
           BLE   PWR   LTE  PWR_2
          (GPIO)(GPIO)(GPIO)(GPIO)
```

---

## 7. 커넥터 및 인터페이스

### 7.1 커넥터 목록

| 참조번호 | 타입 | 핀 수 | 용도 |
|----------|------|-------|------|
| **J1** | MHF | 2 | LTE 안테나 |
| **J2** | MHF | 2 | GPS 안테나 |
| **J103** | 15001WR-04 | 6 | SWD 디버그 |
| **J104** | 15001WR-04 | 6 | UART 디버그 |
| **J202** | BAT | 2 | 배터리 연결 |
| **J203** | 24V | 2 | 외부 전원 입력 |
| **J204** | 2.54mm | 4 | I2C 확장 |
| **J205** | alarm | 2 | 알람 입력 |

### 7.2 SWD 디버그 포트 (J103)

| 핀 | 신호 |
|----|------|
| 1 | VCC_BAT |
| 2 | SWDIO |
| 3 | SWDCLK |
| 4 | GND |
| 5 | GND |
| 6 | GND |

### 7.3 UART 디버그 포트 (J104)

| 핀 | 신호 |
|----|------|
| 1 | VCC_BAT |
| 2 | TX |
| 3 | RX |
| 4 | GND |
| 5 | GND |
| 6 | GND |

---

## 8. 소프트웨어 아키텍처

### 8.1 펌웨어 구조

```
┌─────────────────────────────────────────────────────────────┐
│                    APPLICATION LAYER                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Tracker   │  │   Sensor    │  │    BLE      │         │
│  │   Manager   │  │   Fusion    │  │   Service   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                    MIDDLEWARE LAYER                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │    LTE      │  │    GPS      │  │    IMU      │         │
│  │   Driver    │  │   Parser    │  │   Driver    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                      HAL LAYER                              │
│  ┌───────┐  ┌───────┐  ┌───────┐  ┌───────┐  ┌───────┐    │
│  │ UART  │  │  I2C  │  │  SPI  │  │  GPIO │  │  ADC  │    │
│  └───────┘  └───────┘  └───────┘  └───────┘  └───────┘    │
├─────────────────────────────────────────────────────────────┤
│                   nRF5 SDK / Zephyr RTOS                    │
├─────────────────────────────────────────────────────────────┤
│                   nRF52840 Hardware                         │
└─────────────────────────────────────────────────────────────┘
```

### 8.2 주요 기능 모듈

| 모듈 | 기능 |
|------|------|
| **LTE Manager** | AT 명령 처리, 네트워크 연결, 데이터 전송 |
| **GPS Manager** | NMEA 파싱, 위치 계산, 1PPS 동기화 |
| **IMU Manager** | 센서 퓨전, 자세 추정, 동작 감지 |
| **BLE Service** | 설정, 상태 모니터링, OTA 업데이트 |
| **Power Manager** | 저전력 모드, 배터리 모니터링 |

### 8.3 통신 프로토콜

```c
// LTE AT 명령 예시
AT+CGDCONT=1,"IP","internet"    // APN 설정
AT+CGACT=1,1                     // PDP 활성화
AT+QMTOPEN=0,"broker.mqtt.com",1883  // MQTT 연결
AT+QMTPUB=0,0,0,0,"tracker/location" // 위치 발행

// GPS NMEA 파싱
$GNRMC,123519,A,4807.038,N,01131.000,E,022.4,084.4,230394,003.1,W*6A
$GNGGA,123519,4807.038,N,01131.000,E,1,08,0.9,545.4,M,47.0,M,,*47

// I2C 센서 읽기
Wire.beginTransmission(MPU9250_ADDR);
Wire.write(ACCEL_XOUT_H);
Wire.endTransmission(false);
Wire.requestFrom(MPU9250_ADDR, 14);
```

---

## 9. 응용 분야

### 9.1 적용 가능 프로젝트

| 분야 | 응용 예시 |
|------|-----------|
| **차량 추적** | 실시간 GPS 위치 추적, 주행 기록 |
| **자산 관리** | 고가 장비/물류 위치 모니터링 |
| **개인 안전** | 긴급 위치 전송, SOS 기능 |
| **스포츠/피트니스** | 운동 추적, 동작 분석 |
| **산업용 모니터링** | 원격 장비 상태 감시 |
| **환경 모니터링** | 온습도 데이터 수집 및 전송 |

### 9.2 시스템 특장점

| 특징 | 설명 |
|------|------|
| **다중 통신** | LTE Cat1 + BLE 5.0 동시 지원 |
| **고정밀 위치** | 멀티 GNSS (GPS/GLONASS/Galileo/BeiDou) |
| **동작 감지** | 9축 IMU로 정밀 자세/동작 추정 |
| **환경 센싱** | 온습도 센서로 환경 데이터 수집 |
| **저전력 설계** | nRF52840 저전력 모드, 전원 관리 IC |
| **유연한 전원** | 24V DC + 배터리 듀얼 전원 |
| **확장성** | I2C/UART 확장 포트 |

---

## 10. 설계 검증 항목

### 10.1 하드웨어 검증

| 항목 | 테스트 내용 | 판정 기준 |
|------|-------------|-----------|
| 전원 | 24V 입력 → 3.3V 출력 | 3.3V ± 5% |
| 배터리 충전 | 충전 전류, 종료 전압 | 설정값 ± 10% |
| LTE 통신 | 네트워크 등록, 데이터 전송 | 정상 연결 |
| GPS 수신 | TTFF, 위치 정확도 | < 30s, < 5m |
| IMU 센서 | 가속도/자이로/지자기 | 데이터시트 범위 |
| 온습도 센서 | 온도/습도 측정 | ±0.5°C, ±3% RH |
| BLE 통신 | 연결, 데이터 전송 | 10m 이상 |

### 10.2 소프트웨어 검증

| 항목 | 테스트 내용 |
|------|-------------|
| 부팅 시퀀스 | 전원 인가 → 초기화 → 정상 동작 |
| LTE AT 명령 | 네트워크 등록, MQTT 연결 |
| GPS 파싱 | NMEA 데이터 정확도 |
| 센서 퓨전 | IMU 자세 추정 정확도 |
| 저전력 모드 | 슬립 → 웨이크업 전환 |
| OTA 업데이트 | BLE를 통한 펌웨어 업데이트 |

---

## 11. 참고 자료

### 11.1 데이터시트

- [Nordic nRF52840 Product Specification](https://infocenter.nordicsemi.com/pdf/nRF52840_PS_v1.1.pdf)
- [Quectel EG915U Series Specification](https://www.quectel.com/product/lte-eg915u-series/)
- [Quectel LG77L GNSS Module](https://www.quectel.com/product/gnss-lg77l/)
- [TDK InvenSense MPU9250](https://invensense.tdk.com/products/motion-tracking/9-axis/mpu-9250/)
- [TDK InvenSense ICM20948](https://invensense.tdk.com/products/motion-tracking/9-axis/icm-20948/)
- [ASAIR AHT20](http://www.aosong.com/en/products-32.html)
- [Texas Instruments BQ24072](https://www.ti.com/product/BQ24072)
- [MPS MP4560](https://www.monolithicpower.com/en/mp4560.html)

### 11.2 개발 도구

- nRF Connect SDK
- Segger Embedded Studio
- J-Link Debugger

---

## 12. 버전 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|-----------|
| v1.0 | 2024-09-11 | 초기 회로 설계 |

---

## 13. 라이선스 및 저작권

이 문서는 포트폴리오 목적으로 작성되었습니다.

**주요 부품 제조사:**
- Nordic Semiconductor (nRF52840)
- Quectel (EG915UE, LG77L)
- TDK InvenSense (MPU9250, ICM20948)
- Texas Instruments (BQ24072, TXS0108E)
- MPS (MP4560DN)

---

*본 문서는 nRF52840 기반 LTE/GPS 트래커 시스템의 하드웨어 설계를 위해 작성되었습니다.*
